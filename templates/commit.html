<script>
  const API_URL = "https://api.github.com/repos/OpenRSI/5MCSI_Metriques/commits";

  google.charts.load("current", { packages: ["corechart"] });

  async function loadCommits() {
    const response = await fetch(API_URL);
    const commits = await response.json();

    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    // Objet pour compter les commits par jour
    const commitsByDay = {};

    commits.forEach((item, index) => {
      const dateString = item.commit.author.date;
      const date = new Date(dateString);

      const dayKey = date.toISOString().split("T")[0]; // YYYY-MM-DD
      const hour = date.getHours();
      const minutes = date.getMinutes().toString().padStart(2, "0");

      // Comptage par jour
      if (!commitsByDay[dayKey]) {
        commitsByDay[dayKey] = 0;
      }
      commitsByDay[dayKey]++;

      // Remplissage du tableau
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${index + 1}</td>
        <td>${item.sha.substring(0, 7)}</td>
        <td>${dayKey}</td>
        <td>${hour}h${minutes}</td>
      `;
      tbody.appendChild(row);
    });

    document.getElementById("table").style.display = "table";

    google.charts.setOnLoadCallback(() => drawChart(commitsByDay));
  }

  function drawChart(commitsByDay) {
    const data = new google.visualization.DataTable();
    data.addColumn("string", "Jour");
    data.addColumn("number", "Nombre de commits");

    // Trier les jours chronologiquement
    Object.keys(commitsByDay)
      .sort()
      .forEach(day => {
        data.addRow([day, commitsByDay[day]]);
      });

    const options = {
      title: "Nombre de commits par jour",
      legend: { position: "none" },
      hAxis: {
        title: "Jour",
        slantedText: true,
        slantedTextAngle: 45
      },
      vAxis: {
        title: "Nombre de commits"
      }
    };

    const chart = new google.visualization.ColumnChart(
      document.getElementById("chart_div")
    );

    chart.draw(data, options);
  }
</script>
